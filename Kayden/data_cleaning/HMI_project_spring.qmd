---
title: "HMI_project"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true 
    toc_depth: 4
    embed-resources: true
editor_options: 
  chunk_output_type: console
---

# HMI (Healthy Mind Innovation) Project

## Overview

### Summary

This is a dataset of HMI app users. HMI developed Meditation application which aims to translate science into tools to cultivate and measure well-being. By using this app, people can easily meditate with podcast style daily practice regardless of time and location. There are four kind of meditation sessions in app; Awareness, Connection, Insight and Purpose

Upon downloading the app, users fill out a baseline assessment about 4 pillars(t0), some demographic survey and reported perceived stress score. This assessment is repeated every four weeks, with data collection (t1, t2). Between these assessments, user activity within the app is tracked(e.g. frequency of session completion, time spent in the app).

I'm interested in the interaction between frequency of session completion and perceived stress score on app effectiveness. In other words, I assumed that if people complete more meditation sessions, their ACIP scores measured after eight weeks would be much higher compared to their baseline scores, and this effect will be larger if people have higher stress level.

### Project Purpose

1.  Examine the significant relationships between frequency of session completion, perceived stress, and their interaction on app effectiveness.

focal variables

\- difference : represents the change in app user’s ACID scores between first and last survey, indicating how much their mental will-being improved.

\- stress : Stress is user’s perceived stress score when they first started this app.

\- frequency : how many times users completed each meditation session.

```{q}
#Model : lmer(difference ~ stress_c * frequency_c + (1+frequency_c|subid) + (1+frequency_c * stress_c|itemid), data=data)
```

In the future, I will develop a model to predict future ACIP scores using machine learning.

### Project Progress

#### Part1

1.  Exploring papers that are related with App-based meditation effectiveness and Well-being.
2.  Exploring the HMI Dataset and find the research model.
3.  Data Cleaning
4.  Exploratory Analysis

#### Part2 (LMEM with multiple non-independence)

4.  Data Cleaning for LMEM
5.  Find Fixed / Random effect
6.  Data visualization

#### Future (Machine Learning)

7.  Split data, EDA modeling
8.  Find appropriate model algorithm among configurations
9.  Fit the final model / test the model performance
10. Data Visualization

## Part1

basic setting

```{r}
# load necessary package
#| message: false
options(conflicts.policy = "depends.ok") 
library(tidyverse)
library(Matrix, exclude = c("expand", "pack", "unpack"))
library(lme4)
library(readr)
library(car, exclude = c("recode", "some"))
library(effectsize)
library(kableExtra, exclude = ("group_rows"))

theme_set(theme_classic()) 

# setting for parallel processing
cl <- parallel::makePSOCKcluster(parallel::detectCores(logical = FALSE))
doParallel::registerDoParallel(cl)


# machine learning setting
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_ml.R?raw=true")
tidymodels_conflictRules()

# functions for EDA
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true")
# functions for plotting
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_plots.R?raw=true")

path_data <- "dataset"
```

load dataset

```{r}
# demographic data
data_demographics <- read_csv(here::here(path_data, "demographics.csv"), show_col_types = FALSE) |> janitor::clean_names()

# data for perceived stress score
data_stress <- read_csv(here::here(path_data, "perceived_stress_report_new_cleaned.csv"), show_col_types = FALSE) |> janitor::clean_names()

# data for ACIP scores (t0, t1, t2)
data_t0 <- read_csv(here::here(path_data, "t0_all.csv"), show_col_types = FALSE) |> janitor::clean_names()

data_t1 <- read_csv(here::here(path_data, "t1_all.csv"), show_col_types = FALSE) |> janitor::clean_names()

data_t2 <- read_csv(here::here(path_data, "t2_all.csv"), show_col_types = FALSE) |> janitor::clean_names()

# data for user history (meditation activity)
data_history <- read_csv(here::here(path_data, "user_history_v2.csv"), show_col_types = FALSE) |> janitor::clean_names()

```

### Data Cleaning

1.  demographic data

```{r}
# remove unnessasary variables
data_demographics<-data_demographics |> select(-c(completed_date, completed_time))
data_demographics<-data_demographics |> select(-c(missing_data_count))

# character -> factor
data_demographics <- data_demographics |> mutate(across(where(is.character), factor))

data_demographics<-data_demographics |> select(c(user_id, education, age, gender, race))
                                               
```

2.  data_t0 , t1, t2

```{r}
data_t0 <- data_t0 |> select(-c(completed_date, completed_time))

data_t1 <- data_t1 |> select(-c(completed_date, completed_time, survey_category))

data_t2 <- data_t2 |> select(-c(completed_date, completed_time, survey_category))

data_t0 <- data_t0 |> select(-c(survey_category))
```

```{r}
data_t0<-data_t0 |> select(c(user_id, insight_t0_m, purpose_t0_m, awareness_t0_m, connection_t0_m))
data_t2<-data_t2 |> select(c(user_id, insight_t2_m, purpose_t2_m, awareness_t2_m, connection_t2_m))

```

data_history

```{r}
data_history<-data_history |> select(-c(app_build, app_version, path_uri, practice_posture, practice_speaker, practice_duration))
data_history<-data_history |> select(-c(x, task_type))
data_history<-data_history |> select(-c(participant_id))
data_history<-data_history |> select(-c(app_module, app_part, completion_date))
data_history<-data_history |> select(-c(activity_id))
data_history<-data_history |> group_by(user_id) |> group_by(app_series)

```

```{r}
summary_data_history <- data_history |> 
  filter(activity_status == 'Completed') |> 
  group_by(user_id, app_series, activity_name) |> 
  summarise(n_completed = n(), .groups = "drop")

unique(summary_data_history$activity_name)
```

```{r}
summary_data_history <- summary_data_history |> 
  mutate(activity_type = case_when(
    activity_name %in% c("Mindfulness of Sound", "Open Awareness", "A Tour of the Senses", "Healthy Habits: Setting Intentions", "Healthy Habits: Taking Action", "Relaxing with the Breath", "Mindful Breathing", "Mindfulness of Sensations", "The Art of Doing Less", "The Pull of Distraction", "The Skill of Attention", "The Skill of Mindfulness", "The Skill of Self-Awareness", "Mindfulness for Sleep", "Fall Asleep with Awareness", "Calming the Breath for Sleep", "Wake Up with Awareness", "Mindfulness of Emotions", "Directing Attention", "Training Attention", "Fully Present", "Introducing Mindfulness", "Listen with Presence", "Mindful Seeing", "Weather Check", "Feeling the Breath", "Focus", "Monitoring the Mind", "Transforming Distraction", "Looking Within", "Unguided Practice", "The Wandering Mind", "Introducing Self-Awareness", "Observing Inner Experience", "What Are Thoughts Made Of?", "Check the Weather", "Explore Your Inner Terrain", "The Push and Pull of Emotion", "Go with the Flow", "It's Just Experience", "Mindfulness and the Stress Response", "Stay Open", "A Wandering Mind is an Unhappy Mind", "Background Check", "Home Base", "Creative Space", "Letting Go", "Relaxing into Awareness", "Disrupting Habits", "Everything is Meditation", "From React to Respond", "Mind the Urge", "Unhooking Habits", "Calm and Grounded", "Cool as Ice", "Drop into Calm", "The Calm Presence of Awareness", "Two Forms of Calm", "A True Break", "Relaxing the Mind", "Body Scan for Sleep", "Preparing the Mind and Body for Sleep", "The Benefits of Being Aware", "The Default Mode of Your Brain", "Countdown to Focus", "The Myth of Multitasking", "Automatic Thoughts", "Getting out of the River", "Deconstructing Inner Experience", "Examining the Lens", "Invisible Forces", "Turning Inward", "From Doing to Being", "Your Mind's Natural Habitat", "Your Mind's Natural State", "Calm in the Midst of Chaos", "Exercising with Mindfulness", "Calming the Mind for Sleep", "Self-Regulation", "Attention Economy", "Taming the Monkey Mind", "Unguided Practice Timer", "Awareness: The First Pillar of Well-Being", "Cultivate Attention", "Different Ways to Meditate", "Innate Awareness", "Inner Balance", "Grateful Awareness in Difficult Times", "See Through Thoughts and Emotions", "Difficult Holiday Emotions") ~ "awareness",
    activity_name %in% c("Appreciation", "Feeling Connected", "Kindness", "Widening the Circle","Compassion", "Feeling Appreciation", "Seeing the Good in Ourselves", "Appreciating Friends and Loved Ones", "Valuing Friends and Loved Ones", "A Mirror to the World", "Appreciating Those We Don't Know", "Appreciation for Those We Find Challenging", "Valuing Strangers", "A Positive Wish for Loved Ones", "Rediscover Compassion", "Wishing Your Loved Ones Well", "Your Natural Tendency to Care", "Friends Everywhere", "Friends and Family", "Kindness is Contagious", "Receiving Kindness", "Seeing Kindness in Others", "Compassion for All Beings", "Compassion for Strangers", "Compassion in Challenging Relationships", "Extending Kindness", "Kindness Outside Our Circle", "Kindness is Natural", "Healing Division", "Compassion for Jerks", "Compassion for an Annoying Person", "Grounded Compassion", "Social Animals", "Care and Dignity", "Sharing the Journey", "The World Needs You", "Giving and Receiving Love", "Be Kind to Yourself", "Feeling Kindness", "Innate Basic Goodness", "Kindness is Essential", "Sending Kindness", "Compassion in Difficult Situations", "Compassion is Our Nature", "Sending Self-Compassion", "Survival of the Kindest", "Gratitude", "Our Common Humanity", "Turning Enemies into Friends", "Compassion in Challenging Times", "Flourishing Friendships", "Healing Intergenerational Trauma", "Grateful Awareness", "Compassion for Family Stress", "Connection: The Second Pillar of Well-Being", "A Walk With Appreciation", "Spark Appreciation Confirmation", "Innate Compassion") ~ "connection",
    activity_name %in% c("Exploring Change", "Exploring Conditions", "Exploring the Self", "Looks Can Deceive", "Checking in with Yourself", "The Unexamined Life", "Clarity in Uncertain Times", "Feeling Stuck", "Momentary Overwhelm", "Stepping Out of the River", "Thoughts, Emotions, and the Breath", "Self-Worth", "Drifting Away and Coming Back", "Strengthening Self-Awareness", "The Self-Awareness Toolkit", "It's All About Perspective", "Meaning in the Mundane", "The Experience of Meaning", "The Meaning of Adversity", "Beyond the Labels", "Exploring Change in the Body", "Insight and Why It Matters", "The Web of Experience", "Uncharted Territory", "All the World's a Stage", "Beliefs About Relationships", "Growth Mindset", "The Roles We Play", "The Stories We Tell Ourselves", "Negativity Bias", "Noticing the Positive", "Flavors of Experience", "Likes and Dislikes", "Pleasure and Desire", "Resistance Fuels Suffering", "Thoughts Don't Define Us", "It's Always Here", "Only Thoughts", "Question Your Assumptions", "Hidden Messages", "The Self-Righteous Mind", "Keep Asking Why", "Seeing the Full Picture", "Shifting Sands", "Virtual Reality", "The Third Option", "Inner Voice", "The Power of Acceptance", "Embrace Your Inner Demons", "The Mind that Craves", "Don’t Believe Your Thoughts", "Dealing with Stress", "Exploring Emotion", "Transforming Aggression", "Transforming Difficult Relationships", "The Rich World of Emotion", "Letting Go with Compassion", "The Self-Improvement Trap", "Contemplating Death", "The Hardest Part Is Remembering", "'Oneness' Is More Than a Cliché", "The Good News About Death", "Working with Difficult Emotions during the Holidays", "Insight: The Third Pillar of Well-Being", "Seeds of Appreciation", "Innate Wisdom", "Dealing with Election Anxiety", "Facing Financial Stress", "Embracing Holiday Expectations") ~ "insight",
    activity_name %in% c("Be the Change","Living Your Values", "Healthy Habits: Inspiration", "Dropping Anchor", "A Life Worth Living", "This One Moment", "Envisioning Actions", "A Life of Meaning", "Core Values", "Clarifying Your Values", "Role Models", "Values in Your Life", "A Central Life Aim", "The Importance of Purpose", "The Power of Purpose", "Your 100th Birthday", "Purpose in Relationships", "Choose Meaning", "Don't Search for Meaning", "Finding Meaning in Difficult Times", "Meaning Here and Now", "Be Yourself", "Boundaries of the Self", "Recreating the Self", "The Self-Body Connection", "Build Yourself Up", "Deepening Relationships", "Leave Your Mark", "Our Most Important Relationship", "Walking the Talk", "Growing Through Adversity", "Purpose in Daily Life", "The Little Things", "Every Step Counts", "Healthy Habits: Repetition and Experience", "New Directions", "Shift Perspective", "Sports and Interconnection", "A Moment of Inspiration", "Commuting", "Applying Values to Life", "Groups That Define Us", "Inquiring Into Ideology", "Imagine the Possibilities", "One Act, Many Motivations", "Pause for Purpose", "What's Right?", "A Wider Perspective", "Noticing the Subtle Details", "The Art of Meaning", "Eyes on the Horizon", "Under Pressure", "Courage to Heal", "Flip the Script", "Redefine Yourself", "Transcending The Self", "Guilty Pleasure vs. Fulfillment", "Transform Your Mind With Values", "Transforming Daily Routines", "Values in Difficult Times", "What Are You Feeding Your Mind?", "Interdependence with Nature", "Transforming Physical Pain", "A New Beginning", "Change Your Mind, Change the World", "Changing the World", "Gratitude for Your Body", "Pride in Who We Are", "Sending Breath to Your Body", "Happiness Is a Skill", "Free To Be", "Lean on Your Values", "Wise Selfishness", "Reconnect to the World", "Vision and Motivation", "Interconnected", "The Case Against Self-Criticism", "Finding Meaning at Work", "What's Next?", "Start the Day Right", "Purpose: The Fourth Pillar of Well-Being", "Moments of Inspiration", "The Four Pillars of Well-Being") ~ "purpose",
    activity_name %in% c("Welcome to the Healthy Minds Program", "Intro to Active Meditation", "Intro to Sitting Meditation", "Train the Mind, Rewire the Brain", "Caring for the Brain", "Moment of Rest",  "Counting the Breath", "Introduction") ~ "foundation"
  ))

summary_data_history <- summary_data_history |> select(-c(app_series, activity_name))
```

```{r}
#  group by user_id, activity_type
summary_data_history<-summary_data_history |> mutate(n_completed = 1)

summary_data_history<-summary_data_history |> group_by(user_id, activity_type) |> 
  summarise(total_completed = sum(n_completed), .groups = 'drop')

# eliminate activity_type == 'foundation'
summary_data_history<-summary_data_history |> filter(activity_type != "foundation")
```

data_stress

```{r}
data_stress <- data_stress |> mutate(
  control_irritations = case_match(control_irritations,
                                   "Never" ~ 0,
                                   "Almost Never" ~ 1,
                                   "Sometimes" ~ 2,
                                   "Fairly Often" ~ 3,
                                   "Very Often" ~ 4),
  angered_outside_control = case_match(angered_outside_control,
                                       "Never" ~ 0,
                                       "Almost Never" ~ 1,
                                       "Sometimes" ~ 2,
                                       "Fairly Often" ~ 3,
                                       "Very Often" ~ 4),
  upset_unexpected = case_match(upset_unexpected,
                                "Never" ~ 0,
                                "Almost Never" ~ 1,
                                "Sometimes" ~ 2,
                                "Fairly Often" ~ 3,
                                "Very Often" ~ 4),
  confidence_handle_problems = case_match(confidence_handle_problems, 
                                "Never" ~ 4,
                                "Almost Never" ~ 3,
                                "Sometimes" ~ 2,
                                "Fairly Often" ~ 1,
                                "Very Often" ~ 0),
  difficulties_not_overcome = case_match(difficulties_not_overcome, 
                                "Never" ~ 0,
                                "Almost Never" ~ 1,
                                "Sometimes" ~ 2,
                                "Fairly Often" ~ 3,
                                "Very Often" ~ 4),
  nervous_stressed = case_match(nervous_stressed, 
                                "Never" ~ 0,
                                "Almost Never" ~ 1,
                                "Sometimes" ~ 2,
                                "Fairly Often" ~ 3,
                                "Very Often" ~ 4),
  things_going_way = case_match(things_going_way, 
                                "Never" ~ 0,
                                "Almost Never" ~ 1,
                                "Sometimes" ~ 2,
                                "Fairly Often" ~ 3,
                                "Very Often" ~ 4),
  on_top_of_things = case_match(on_top_of_things, 
                                "Never" ~ 4,
                                "Almost Never" ~ 3,
                                "Sometimes" ~ 2,
                                "Fairly Often" ~ 1,
                                "Very Often" ~ 0),
  unable_to_control_important = case_match(unable_to_control_important, 
                                "Never" ~ 0,
                                "Almost Never" ~ 1,
                                "Sometimes" ~ 2,
                                "Fairly Often" ~ 3,
                                "Very Often" ~ 4),
  cannot_cope_with_tasks = case_match(cannot_cope_with_tasks, 
                                "Never" ~ 0,
                                "Almost Never" ~ 1,
                                "Sometimes" ~ 2,
                                "Fairly Often" ~ 3,
                                "Very Often" ~ 4))
```

```{r}
# calculate sum of stress score
data_stress<-data_stress |> mutate(
  stress_total = rowSums(across(control_irritations:cannot_cope_with_tasks)))

data_stress<-data_stress |> select(c(user_id, stress_total))
```

```{r}
# inner join the table
data_total <- dplyr::inner_join(x=data_t0, y=data_t2, by = "user_id")
data_total <- dplyr::inner_join(x=data_total, y=data_demographics, by="user_id")
data_total <- inner_join(x=data_total, y=data_stress, by="user_id")
data_total <- dplyr::inner_join(x=data_total, y=summary_data_history, by="user_id")

```

```{r}
# simplify the user_id
data_total <- data_total |> mutate(user_id = as.integer(factor(user_id)))
```

```{r}
data_total |> skim_some()

data_total <- na.omit(data_total)
```

### analysis the model

```{r}
data_total1 <-data_total |> 
  group_by(user_id) |> 
  filter(n() == 4) |> 
  ungroup()
```

```{r}
data_total2 <-data_total |> 
  group_by(user_id) |> 
  filter(n() > 4) |> 
  ungroup()

data_total2<-data_total2 |> 
  group_by(user_id) |> 
  slice_head(n=4) |> 
  ungroup()
```

```{r}
data_total <- bind_rows(data_total1, data_total2) |> arrange(user_id)
```

```{r}
data_wide <- data_total |> 
  pivot_wider(names_from = "activity_type",
              values_from = "total_completed")
```

ancova approach

```{r}
data_wide <- data_wide |> mutate(
  total_t0 = purpose_t0_m + awareness_t0_m + insight_t0_m + connection_t0_m,
  total_t2 = purpose_t2_m + awareness_t2_m +
    insight_t2_m + connection_t2_m)
```

```{r}
# change list type to double
data_wide <- data_wide |> 
  mutate(
    awareness = map_dbl(awareness,~ as.numeric(.x)[1]),
    insight = map_dbl(insight,~ as.numeric(.x)[1]),
    connection = map_dbl(connection, ~ as.numeric(.x)[1]),
    purpose = map_dbl(purpose, ~ as.numeric(.x)[1])
  )
```

```{r}
data_wide <-data_wide |> 
  mutate(
    total_completed = awareness + connection + insight + purpose) |> 
  rename(
    awareness_completed = awareness,
    connection_completed = connection,
    insight_completed = insight,
    purpose_completed = purpose
  )
```

```{r}
data_wide <- data_wide |> mutate(
  stress_total_c = stress_total - mean(stress_total, na.rm=TRUE),
  total_completed_c = total_completed - mean(total_completed, na.rm=TRUE),
  awareness_completed_c = awareness_completed - mean(awareness_completed, na.rm=TRUE),
  connection_completed_c = connection_completed - mean(connection_completed, na.rm=TRUE)
)
```

```{r}
data_wide <- data_wide |> rename(
  pre_score = total_t0,
  post_score = total_t2
)
```

test the model

```{r}
m_ancova <- lm(post_score ~ total_completed_c*stress_total_c + pre_score, data=data_wide)

summary(m_ancova)
kableExtra::kbl(broom::tidy(m_ancova)) |> kable_styling('striped')
confint(m_ancova)

t1 <- broom::tidy(m_ancova)
t2<-confint(m_ancova)
t <- bind_cols(t1, t2)

t$`Eta2(partial)`<-c('', 0.05, 0.15, 0.42, '6.53e-04')
kableExtra::kbl(t) |> kable_styling('striped')
```

```{r}
kableExtra::kbl(effectsize::eta_squared(m_ancova, partial = TRUE))
```

```{r}
data_wide <- data_wide |> rename(
  pre_awareness = awareness_t0_m,
  post_awareness = awareness_t2_m
)

m_ancova_awareness <- lm(post_awareness ~ pre_awareness + awareness_completed_c*stress_total_c, data=data_wide)
summary(m_ancova_awareness)

kableExtra::kbl(broom::tidy(m_ancova_awareness)) |> kable_styling('striped')

```

```{r}

data_wide <- data_wide |> rename(
  pre_connection = connection_t0_m,
  post_connection = connection_t2_m
)

m_ancova_connection <- lm(post_connection ~ pre_connection + connection_completed_c*stress_total_c, data=data_wide)
kableExtra::kbl(broom::tidy(m_ancova_connection)) |> kable_styling('striped')
```

### explanatory data analysis

```{r}
# functions for EDA
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true")
# functions for plotting
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_plots.R?raw=true")

```

```{r}
# univariate(stress)
data_wide |> plot_bar("stress_total")
```

```{r}
data_wide |> plot_hist("total_completed")
```



```{r}
data_wide |> 
  select("pre_score", "post_score") |> 
  names() |> 
  map(\(name) plot_hist(df=data_wide, x=name)) |> 
  cowplot::plot_grid(plotlist=_, ncol=2)
```

```{r}

data_wide<-data_wide |> mutate(
  difference = post_score - pre_score)
```


```{r}
m_graph <- lm(difference ~ total_completed*stress_total, data=data_wide)

summary(m_graph)
```

```{r}
colSums(is.na(data_wide))

```

```{r}
d_graph <- expand_grid(total_completed = c(mean(data_wide$total_completed, na.rm = TRUE)-sd(data_wide$total_completed, na.rm=TRUE),
                                           mean(data_wide$total_completed, na.rm=TRUE) + sd(data_wide$total_completed, na.rm=TRUE)),
                       stress_total = seq(from = min(data_wide$stress_total),
                                          to = max(data_wide$stress_total),
                                          length.out = 100))
```

```{r}
d_graph <- expand_grid(stress_total = c(mean(data_wide$stress_total, na.rm = TRUE)-sd(data_wide$stress_total, na.rm=TRUE),
                                           mean(data_wide$stress_total, na.rm=TRUE) + sd(data_wide$stress_total, na.rm=TRUE)),
                       total_completed = seq(from = min(data_wide$total_completed, na.rm=TRUE),
                                          to = max(data_wide$total_completed, na.rm=TRUE),
                                          length.out = 100))
```

```{r}
preds <- predict(m_graph, newdata=d_graph, se.fit = TRUE) |> 
  as_tibble() |> 
  mutate(upper = fit+se.fit,
         lower = fit-se.fit) |> 
  bind_cols(d_graph)
```

```{r}
preds <- preds |> mutate(stress_total_lab = factor(stress_total,
                                                      c(mean(data_wide$stress_total, na.rm=TRUE) - sd(data_wide$stress_total, na.rm=TRUE),
                                                        mean(data_wide$stress_total, na.rm=TRUE) + sd(data_wide$stress_total, na.rm=TRUE)),
                                                      c('-1 SD', '+1 SD')))
```

```{r}
ggplot2::ggplot()+
  geom_smooth(data=preds, stat='identity',
              aes(x=total_completed, y=fit, ymin = lower, ymax=upper, color = stress_total_lab, fill=stress_total_lab))+
  labs(x = 'The number of session completed',
       y = 'Change in ACID score',
       color = 'Perceived stress',
       fill = 'Perceived stress',
       title = 'Interaction between session completed and stress on Mental Well-being')+
  scale_color_brewer(palette = 'Set2')+
  scale_fill_brewer(palette = 'Set2')
```

```{r}
data_wide <- data_wide |> select(user_id, stress_total,total_completed,  pre_score, post_score, difference, everything())
```

```{r}
kableExtra::kbl(head(data_wide, 10)) |> kable_styling("striped", full_width = FALSE)
```

$\text{post_test}_{i}= \beta_{0} + \beta_{1} * session_{i} + \beta_{2} * stress_{i} + \beta_{3} * session_{i}*stress_{i}+ \beta_{4} * \text{pre_test}_{i} + e_{i}$

$\text{post_test_con}_{i}= \beta_{0} + \beta_{1} * \text{session_con}_{i} + \beta_{2} * stress_{i} + \beta_{3} * \text{session_con}_{i}*stress_{i}+ \beta_{4} * \text{pre_test_con}_{i} + e_{i}$

$\text{post_test_awar}_{i}= \beta_{0} + \beta_{1} * \text{session_awar}_{i} + \beta_{2} * stress_{i} + \beta_{3} * \text{session_awar}_{i}*stress_{i}+ \beta_{4} * \text{pre_test_awar}_{i} + e_{i}$

var graph
```{r}
m_graph <- lm(post_score ~ total_completed*stress_total + pre_score, data=data_wide)
d_graph <- expand_grid(
  total_completed = c(mean(data_wide$total_completed, na.rm = TRUE)-sd(data_wide$total_completed, na.rm=TRUE), 
                      mean(data_wide$total_completed, na.rm=TRUE) + sd(data_wide$total_completed, na.rm=TRUE)),
  stress_total = mean(data_wide$stress_total),
  pre_score = mean(data_wide$pre_score)
  )
```

```{r}
preds <- predict(m_graph, d_graph, se.fit=T) |> 
  as_tibble() |> 
  bind_cols(d_graph) |> 
  mutate(upper = fit+se.fit,
         lower = fit-se.fit)
```

```{r}
preds <- preds |> mutate(total_completed_lab = factor(total_completed,
                                                      c(mean(data_wide$total_completed, na.rm=TRUE) - sd(data_wide$total_completed, na.rm=TRUE),
                                                        mean(data_wide$total_completed, na.rm=TRUE) + sd(data_wide$total_completed, na.rm=TRUE)),
                                                      c('-1 SD', '+1 SD')))
```

```{r}
ggplot(data=preds, aes(x=total_completed_lab, y=fit, fill = total_completed_lab))+
  geom_bar(stat='identity')+
  geom_errorbar(aes(ymax=upper, ymin=lower), width = .5)+
  labs(y="ACID score", x="The number of session completed", fill = "")+
  scale_color_brewer(palette = 'Set2')+
  scale_fill_brewer(palette = 'Set2')
```
